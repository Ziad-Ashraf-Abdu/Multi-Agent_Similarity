<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tactical Retrieval Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pitch {
            background-color: #2f855a; /* Grass Green */
            border: 2px solid white;
            position: relative;
        }
        .pitch-line {
            stroke: white;
            stroke-width: 2;
            fill: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
        <h1 class="text-xl font-bold text-green-400">Play2Vec <span class="text-white">Pattern Visualizer</span></h1>
        <div>
            <label class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded cursor-pointer transition">
                Upload Match JSON
                <input type="file" id="fileInput" class="hidden" accept=".json">
            </label>
            <span id="status" class="ml-3 text-gray-400 text-sm">Waiting for file...</span>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR: LIST OF DETECTED PLAYS -->
        <div class="w-1/4 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-3 bg-gray-700 font-semibold text-sm uppercase tracking-wide">
                Detected Plays <span id="playCount" class="bg-gray-900 px-2 rounded ml-2">0</span>
            </div>
            <div id="playList" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Play Items injected here via JS -->
                <div class="text-gray-500 text-center mt-10 text-sm">Upload a file to see plays.</div>
            </div>
        </div>

        <!-- MAIN STAGE: PITCH VISUALIZER -->
        <div class="flex-1 bg-gray-900 p-6 flex flex-col items-center justify-center relative">
            
            <div class="relative">
                <!-- THE PITCH (SVG) -->
                <svg id="pitchSvg" width="800" height="530" class="pitch rounded shadow-2xl">
                    <!-- Center Line -->
                    <line x1="400" y1="0" x2="400" y2="530" class="pitch-line" />
                    <circle cx="400" cy="265" r="50" class="pitch-line" />
                    <!-- Penalty Areas -->
                    <rect x="0" y="130" width="120" height="270" class="pitch-line" />
                    <rect x="680" y="130" width="120" height="270" class="pitch-line" />
                </svg>

                <!-- LEGEND -->
                <div class="absolute top-4 right-4 bg-gray-900/80 p-3 rounded backdrop-blur">
                    <div class="flex items-center mb-1">
                        <span class="w-4 h-4 bg-blue-500 rounded-full mr-2"></span>
                        <span class="text-sm">Input Play</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 bg-red-500 rounded-full mr-2"></span>
                        <span class="text-sm">AI Match</span>
                    </div>
                </div>
            </div>

            <div id="playInfo" class="mt-4 text-center">
                <h2 class="text-2xl font-light">Select a play to visualize</h2>
                <p class="text-gray-500 text-sm">The AI will overlay the most similar historical pattern.</p>
            </div>

        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const playList = document.getElementById('playList');
        const playCount = document.getElementById('playCount');
        const pitchSvg = document.getElementById('pitchSvg');
        const playInfo = document.getElementById('playInfo');

        let analysisData = null;

        // HANDLE FILE UPLOAD
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = "Analyzing patterns...";
            status.className = "ml-3 text-yellow-400 text-sm animate-pulse";

            const formData = new FormData();
            formData.append('file', file);

            try {
                // CALL LOCAL FASTAPI SERVER
                const response = await fetch('http://127.0.0.1:8000/analyze_match', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Server Error");

                const data = await response.json();
                analysisData = data.analysis_results;
                
                status.textContent = "Analysis Complete";
                status.className = "ml-3 text-green-400 text-sm";
                renderPlayList(analysisData);

            } catch (err) {
                console.error(err);
                status.textContent = "Error: Is server running?";
                status.className = "ml-3 text-red-500 text-sm";
            }
        });

        // RENDER SIDEBAR LIST
        function renderPlayList(plays) {
            playList.innerHTML = '';
            playCount.textContent = plays.length;

            plays.forEach((play, index) => {
                const div = document.createElement('div');
                const bestScore = play.matches[0] ? play.matches[0].similarity_score.toFixed(1) : 'N/A';
                
                div.className = "bg-gray-700 hover:bg-gray-600 p-3 rounded cursor-pointer transition border-l-4 border-transparent hover:border-blue-500";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-white">Play #${index + 1}</span>
                        <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300">${play.length} Passes</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Best Match Score: <span class="text-green-400">${bestScore}</span></div>
                `;
                
                div.onclick = () => loadPlayOnPitch(play, index);
                playList.appendChild(div);
            });
        }

        // DRAW PLAY ON PITCH
        function loadPlayOnPitch(play, index) {
            // clear previous lines (keep pitch markings)
            const dynamicElements = pitchSvg.querySelectorAll('.dynamic-draw');
            dynamicElements.forEach(el => el.remove());

            playInfo.innerHTML = `
                <h2 class="text-2xl font-bold text-white">Play #${index + 1} vs Match</h2>
                <p class="text-gray-400">Match ID: ${play.matches[0]?.match_play_id || 'None'}</p>
            `;

            // 1. Draw Input (Blue)
            drawTrajectory(play.input_trajectory, "blue", 4);

            // 2. Draw Match (Red)
            if (play.matches.length > 0) {
                drawTrajectory(play.matches[0].match_trajectory, "red", 2, true);
            }
        }

        function drawTrajectory(coords, color, width, isDash = false) {
            // Coordinate Mapping: 
            // Data is roughly -55 to 55 (X) and -35 to 35 (Y)
            // SVG is 0 to 800 (X) and 0 to 530 (Y)
            
            const scaleX = 800 / 110; // Width / 110m
            const scaleY = 530 / 70;  // Height / 70m
            const offsetX = 400;      // Center X
            const offsetY = 265;      // Center Y

            // Create Path String
            let d = "";
            coords.forEach((point, i) => {
                // Invert Y because SVG y-axis is top-down, pitch data is usually bottom-up or centered
                const x = (point[0] * scaleX) + offsetX; 
                const y = (point[1] * -scaleY) + offsetY; // Flip Y for typical cartesian
                
                if (i === 0) d += `M ${x} ${y}`;
                else d += ` L ${x} ${y}`;

                // Draw Dot at start
                if (i === 0) {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", x);
                    circle.setAttribute("cy", y);
                    circle.setAttribute("r", 5);
                    circle.setAttribute("fill", color);
                    circle.setAttribute("class", "dynamic-draw");
                    pitchSvg.appendChild(circle);
                }
            });

            // Draw Path
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", d);
            path.setAttribute("stroke", color === "blue" ? "#3b82f6" : "#ef4444");
            path.setAttribute("stroke-width", width);
            path.setAttribute("fill", "none");
            path.setAttribute("class", "dynamic-draw");
            if (isDash) path.setAttribute("stroke-dasharray", "5,5"); // Dashed line for match
            
            pitchSvg.appendChild(path);
        }

    </script>
</body>
</html>